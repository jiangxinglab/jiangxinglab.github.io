---
layout : post
title : 那些年踩过的坑
---

# 那些年踩过的坑

### 一、程序代码 !≌ 业务逻辑 导致OOM

1.1 项目名称：impala on pg
1.2 细节描述：

> 1.2.1 代码使用的语言是：C++(impala 后端部分是用c++写的)
> 1.2.2 代码想要做的事情是：申请一块内存空间，去PG查数据，填充数据到内存空间。
> 1.2.3 代码出现问题的点是：没有考虑到所有的路径。
> 1.2.4 考虑到的路径：申请内存抛出异常、查PG抛出异常、PG返回记录行数大于0。
> 1.2.5 **没有考虑到的路径：PG返回记录行数等于0。**
> 1.2.6 **导致的问题：OOM，因为，那块内存在PG返回记录行数等于0的时候不会释放，积少成多，导致内存爆了。**

1.3 教训：

>1.3.1 更多的单元测试：程序大多数bug，经常发身在非常简单的地方，单元测试很容易帮我们发现这些问题。
>1.3.1 提高思维严谨性：要像写证明题那样来写代码。
>1.3.1 保持代码简洁：越是简洁的代码越容易发现问题。

### 二、多线程下访问静态变量没有同步 导致sql查询不一致

2.1 项目名称：impala on pg
2.2 后果描述：

> 2.2.1 假设table t1包含字段a,b,c;
> 2.2.2 select * from t1;的结果只有字段a的值，木有b、c字段的值，也就是说这个表被纵向截断了。

2.3 细节描述：

> 2.3.1 代码使用的语言是：JAVA(impala 前端部分是用java写的)
> 2.3.2 代码想要做的事情：将语法树解析为SQL，放到一个变量中（一个语法解析的逆向过程，至于为什么这么纠结，我没有深究）
> 2.3.3 代码出问题的点是：用了一个static变量来存放这个SQL，同时没有做同步，导致多线程环境下，这个SQL拼接的结果不可预期。

2.4 教训：

> 2.4.1 夯实基础：没能透彻的了解使用static关键字意味着什么（可见性扩散到了多线程环境）。
> 2.4.2 危险意识：使用之前确保自己能hold住这个东东，否则不要用。
