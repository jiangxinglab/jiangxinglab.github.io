---
layout : post
title : 那些年踩过的坑
---

# 那些年踩过的坑

### 程序员缺少产品意识，导致生产出糟糕的产品

1 项目名称：IOS SDK
2 后果描述：

> 2.1 产品的功能不符合实际环境，导致产品不能正常的发布。

3 细节描述：

> 3.1 使用的语言：Objective C
> 3.2 产品想要做的事情：在用户触发相应的事件时，展示富媒体广告。
> 3.2 产品出现问题的点：展示富媒体广告时，会去获取广告素材，在这个过程中，如果失败了，用户看不到任何行为（就好像没有触发事件一样）。然而，这样是不对的，就像浏览器一样，如果我点击一个url，不管这个url是否能成功获取资源，都应该弹出一个tab页（这样客户不会觉得奇怪，很明显知道是资源加载失败了）。

4 教训：

> 4.1 培养产品意识：程序员不应该将自己局限于一个死的工具；而应该，思考产品，做一个守门员，守住那些糟糕的需求。



### 程序代码 !≌ 业务逻辑 导致OOM

1 项目名称：impala on pg
2 细节描述：

> 2.1 代码使用的语言是：C++(impala 后端部分是用c++写的)
> 2.2 代码想要做的事情是：申请一块内存空间，去PG查数据，填充数据到内存空间。
> 2.3 代码出现问题的点是：没有考虑到所有的路径。
> 2.4 考虑到的路径：申请内存抛出异常、查PG抛出异常、PG返回记录行数大于0。
> 2.5 **没有考虑到的路径：PG返回记录行数等于0。**
> 2.6 **导致的问题：OOM，因为，那块内存在PG返回记录行数等于0的时候不会释放，积少成多，导致内存爆了。**

3 教训：

>3.1 更多的单元测试：程序大多数bug，经常发身在非常简单的地方，单元测试很容易帮我们发现这些问题。
>3.1 提高思维严谨性：要像写证明题那样来写代码。
>3.1 保持代码简洁：越是简洁的代码越容易发现问题。

### 多线程下访问静态变量没有同步 导致sql查询不一致

1 项目名称：impala on pg
2 后果描述：

> 2.1 假设table t1包含字段a,b,c;
> 2.2 select * from t1;的结果只有字段a的值，木有b、c字段的值，也就是说这个表被纵向截断了。

3 细节描述：

> 3.1 代码使用的语言是：JAVA(impala 前端部分是用java写的)
> 3.2 代码想要做的事情：将语法树解析为SQL，放到一个变量中（一个语法解析的逆向过程，至于为什么这么纠结，我没有深究）
> 3.3 代码出问题的点是：用了一个static变量来存放这个SQL，同时没有做同步，导致多线程环境下，这个SQL拼接的结果不可预期。

4 教训：

> 4.1 夯实基础：没能透彻的了解使用static关键字意味着什么（可见性扩散到了多线程环境）。
> 4.2 危险意识：使用之前确保自己能hold住这个东东，否则不要用。

### mysql主从数据同步延迟 导致系统没有达到最终一致性

Q1：系统为什么没有达到最终一致性？  
A1：
1、系统update一个操作涉及到三个组件，数据库，消息队列，全文索引。
2、数据库采用主从的方式。
3、每次更新数据，更新到主库（数据异步同步到从库）；然后发送消息到消息队列（发送失败并不回滚更新操作）；最后接受消息通过id去从库查询对应数据，并向从库获取数据，更新到全文索引中。  
4、很明显消息丢失会造成数据不能达到最终一致性。   
5、比较隐含的点是跟新全文索引的时候，由于取的是从库，这时候主库的数据可能还没有同步到从库，可能拿到过时的数据，然后更新到全文索引中。  

> Q1.1 跟新数据库、全文索引的操作为什么不同步？   

> Q1.2 跟新全文索引的时候为什么不从主库获取数据？

### Long.equals(Integer) 始终返回false

Q1: 为什么Long.equals(Integer)始终返回false?
A1: equals操作会比较类型，如果类型不一致，就会返回false

Q2：为什么一开始不测试一下，或者看看代码？
A2: 以为没有什么问题。

> Q2.1 为什么会以为没有什么问题？    
